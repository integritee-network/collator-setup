{# --- PREPARE VARIABLES #}
{% set node_name = hostvars[inventory_hostname].node_name|default(None) %}
{% set execution = hostvars[inventory_hostname].execution|default(None) %}
{% set wasm_execution = hostvars[inventory_hostname].wasm_execution|default(None) %}
{% set telemetry_url = hostvars[inventory_hostname].telemetry_url|default(None) %}
{% set enable_reverse_proxy = hostvars[inventory_hostname].enable_reverse_proxy|default(None) %}
{% set logging_filter = hostvars[inventory_hostname].logging_filter|default(None) %}
{% set base_path = hostvars[inventory_hostname].base_path|default(None) %}
{% set additional_flags = hostvars[inventory_hostname].additional_flags|default(None) %}
{% set is_collator = hostvars[inventory_hostname].is_collator|default(false) %}
{% set is_public= hostvars[inventory_hostname].is_public|default(false) %}
{% set ip_address = hostvars[inventory_hostname].ip_address |default(None) %}

{% set additional_common_flags = hostvars[inventory_hostname].parachain_additional_common_flags|default(None) %}
{% set additional_collator_flags = hostvars[inventory_hostname].parachain_additional_collator_flags|default(None) %}
{% set additional_public_flags = hostvars[inventory_hostname].parachain_additional_public_flags|default(None) %}


{# ## Legacy/deprecated flags #}
{% if node_name is none %}
  {% set node_name = hostvars[inventory_hostname].nodeName|default(None) %}
{% endif %}
{% if telemetry_url is none %}
  {% set telemetry_url = hostvars[inventory_hostname].telemetryUrl|default(None) %}
{% endif %}
{% if enable_reverse_proxy is none %}
  {% set enable_reverse_proxy = hostvars[inventory_hostname].enableReverseProxy|default(None) %}
{% endif %}
{% if logging_filter is none %}
  {% set logging_filter = hostvars[inventory_hostname].loggingFilter|default(None) %}
{% endif %}
{# --- #}
[Unit]
Description=Parachain Collator Node
After=network.target
StartLimitIntervalSec=0

[Service]
User=polkadot
Group=polkadot
ExecStart=/usr/local/bin/collator \
  {% if execution is not none and execution|length %}
  --execution {{ execution }} \
  {% endif %}
  {% if node_name is not none and node_name|length %}
  --name {{ node_name }} \
  {% else %}
  --name {{ project|default('project') }}-sv-collator-{{ groups['collator'].index(inventory_hostname) }} \
  {% endif %}
  {% if telemetry_url is not none and telemetry_url|length %}
    {% set urls = telemetry_url.split(',') %}
    {% for url in urls %}
  --telemetry-url '{{ url }} 1' \
    {% endfor %}
  {% else %}
  --no-telemetry \
  {% endif %}
  {% if enable_reverse_proxy is not none and enable_reverse_proxy is sameas true %}
  --public-addr=/ip4/{{ hostvars[inventory_hostname].public_ip.json.ip }}/tcp/{{ proxy_port }} \
  {% endif %}
  {% if logging_filter is not none and logging_filter|length %}
  -l{{ logging_filter }} \
  {% endif %}
  {% if base_path is not none and base_path|length %}
  --base-path '{{ base_path }}' \
  {% endif %}
  {% if additional_flags is not none and additional_flags|length %}
  {{ additional_flags }} \
  {% endif %}
  {# --- DEPRECATED --- #}
  {% if additional_common_flags is not none and additional_common_flags|length %}
  {{ additional_common_flags }} \
  {% endif %}
  {% if is_collator is sameas true and additional_collator_flags is not none and additional_collator_flags|length %}
  {{ additional_collator_flags }} \
  {% endif %}
  --ws-port {{ parachain_ws_port }} \
  {% if is_public is sameas true %}
  --rpc-cors all \
  {% endif %}
  {% if is_public is sameas true and additional_public_flags is not none and additional_public_flags|length %}
  {{ additional_public_flags }} \
  {% endif %}
  {# --- #}
  --chain={{ parachain }} \
  --listen-addr=/ip4/127.0.0.1/tcp/{{ parachain_p2p_port }} \
  --rpc-methods=Unsafe \
  {# --- RELAY CHAIN STUFF #}
  -- --execution wasm \
  --listen-addr=/ip4/127.0.0.1/tcp/{{ relaychain_p2p_port }} \
  --ws-port {{ relaychain_ws_port }} \
  --prometheus-port=9614
Restart=always
RestartSec=60

[Install]
WantedBy=multi-user.target
